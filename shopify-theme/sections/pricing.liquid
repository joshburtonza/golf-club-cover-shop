{%- assign collection = section.settings.collection -%}

<section class="pricing section--lg" id="pricing" data-section-id="{{ section.id }}">
  <div class="container">
    <div class="text-center" style="margin-bottom:2rem;">
      <span class="section__label">{{ section.settings.subtitle }}</span>
      <h2 class="section__heading">{{ section.settings.heading }}</h2>
    </div>

    <div class="pricing__grid">
      {%- if collection != blank -%}
        {%- for product in collection.products limit: section.settings.products_to_show -%}
          {%- assign is_bundle = false -%}
          {%- assign is_custom = false -%}
          {%- assign title_lower = product.title | downcase -%}

          {%- if title_lower contains 'bundle' or title_lower contains 'pack' or title_lower contains 'scramble' -%}
            {%- assign is_bundle = true -%}
          {%- endif -%}
          {%- if title_lower contains 'build your own' or title_lower contains 'custom' -%}
            {%- assign is_custom = true -%}
          {%- endif -%}

          <div class="pricing__card{% if is_bundle or is_custom %} pricing__card--featured{% endif %}">
            {%- if is_bundle and is_custom == false -%}
              <span class="pricing__badge pricing__badge--gold">Save R500</span>
            {%- endif -%}
            {%- if is_custom -%}
              <span class="pricing__badge pricing__badge--walnut">Customise</span>
            {%- endif -%}

            <div class="pricing__card-header{% if is_bundle or is_custom %}" style="padding-top:0.5rem;{% endif %}">
              <h3 class="pricing__card-title">{{ product.title }}</h3>
              {%- if product.description != blank -%}
                <p class="pricing__card-desc">{{ product.description | strip_html | truncate: 80 }}</p>
              {%- endif -%}
            </div>

            {%- if product.featured_image -%}
              <div class="pricing__card-image">
                <img
                  src="{{ product.featured_image | image_url: width: 600 }}"
                  alt="{{ product.title }}"
                  loading="lazy"
                  width="600"
                  height="600"
                >
              </div>
            {%- endif -%}

            <div class="pricing__card-price">
              {% render 'sale-price', product: product, size: 'xl' %}
              {%- if is_custom -%}
                <p class="pricing__card-note">3 piece bundle</p>
              {%- endif -%}
            </div>

            <form method="post" action="/cart/add">
              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
              <input type="hidden" name="quantity" value="1">
              <button
                type="submit"
                class="btn btn-full{% if is_bundle or is_custom %} btn-gold{% else %} btn-walnut-outline{% endif %} btn-lg"
                {% unless product.available %}disabled{% endunless %}
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 002 1.58h9.78a2 2 0 001.95-1.57l1.65-7.43H5.12"/></svg>
                {% if product.available %}Add to Cart{% else %}Sold Out{% endif %}
              </button>
            </form>
          </div>
        {%- endfor -%}
      {%- else -%}
        {%- for i in (1..3) -%}
          <div class="pricing__card{% if i == 2 %} pricing__card--featured{% endif %}">
            {%- if i == 2 -%}
              <span class="pricing__badge pricing__badge--gold">Save R500</span>
            {%- endif -%}
            <div class="pricing__card-header">
              <h3 class="pricing__card-title">Sample Product {{ i }}</h3>
              <p class="pricing__card-desc">Connect a collection to see your products</p>
            </div>
            <div class="pricing__card-price">
              <div class="sale-price sale-price--xl">
                <div class="sale-price__row">
                  <span class="sale-price__current">R 375</span>
                </div>
              </div>
            </div>
          </div>
        {%- endfor -%}
      {%- endif -%}
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Pricing Cards",
  "settings": [
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Pick Your Poison"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Simple Pricing"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to show",
      "min": 1,
      "max": 12,
      "default": 6
    }
  ],
  "presets": [
    {
      "name": "Pricing Cards"
    }
  ]
}
{% endschema %}
